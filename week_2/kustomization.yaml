apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base

# å¯¹ä»»æ„ YAML å­—æ®µè¿›è¡Œè¦†å†™
patches:
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: lyzhang1999/vote:env
    target:
      kind: Deployment
      name: vote

helmCharts:
  - name: redis
    version: "17.16.0"
    repo: "https://charts.bitnami.com/bitnami"
    valuesInline:
      fullnameOverride: redis
      auth:
        enabled: false
  - name: postgresql-ha
    version: "11.9.0"
    repo: "https://charts.bitnami.com/bitnami"
    valuesInline:
      fullnameOverride: db
      global:
        postgresql:
          username: postgres
          password: postgres
          database: postgres
          repmgrUsername: postgres
          repmgrPassword: postgres

# æ–°å¢ Pre-install Hook (Job)
patchesStrategicMerge:
  - |-
    apiVersion: batch/v1
    kind: Job
    metadata:
      name: pre-install-job
      annotations:
        helm.sh/hook: pre-install       # å£°æ˜ä¸º Helm Pre-install Hook
        helm.sh/hook-weight: "-5"      # å¯é€‰ï¼šæ§åˆ¶æ‰§è¡Œé¡ºåºï¼ˆè¶Šå°è¶Šå…ˆæ‰§è¡Œï¼‰
    spec:
      template:
        spec:
          containers:
          - name: pre-install
            image: alpine              # ä½¿ç”¨è½»é‡çº§ Alpine Linux
            command: ["sh", "-c"]
            args:
              - echo "ğŸš€ Running Pre-install Hook..."
              echo "This job runs BEFORE the Helm chart is installed!"
              echo "Current time: $(date)"
              echo "Waiting 5 seconds..."
              sleep 5
              echo "âœ… Pre-install Job Completed!"
          restartPolicy: Never
      backoffLimit: 1                  # å¤±è´¥é‡è¯•æ¬¡æ•°